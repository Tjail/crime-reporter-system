{% extends 'landing/base.html' %}
{% load static %}

{% block content %}
<div class="container">
  <h2 class="mb-3">
    <i class="fas fa-map-marker-alt text-danger"></i> Quick Pin Drop
  </h2>
  
  <p class="text-muted">Mark suspicious activity without revealing your live location. Select a reason, optionally add details, and drop your pin.</p>
  
  <form method="POST">
    {% csrf_token %}
    
    <div id="pinMap" style="height: 400px; border-radius: 8px; margin-bottom: 20px;"></div>
    
    <input type="hidden" name="latitude" id="latitude" required>
    <input type="hidden" name="longitude" id="longitude" required>
    
    <div class="mb-3">
      <label class="form-label fw-bold">Reason for Pin Drop:</label>
      <select name="reason" class="form-select" required>
        <option value="" selected disabled>Select reason</option>
        <option value="Suspicious Activity">Suspicious Activity</option>
        <option value="Petty Crime">Petty Crime (e.g. theft, vandalism)</option>
        <option value="Felony Crime">Felony Crime (e.g. assault, armed robbery)</option>
      </select>
    </div>
    
    <div class="mb-3">
      <label class="form-label fw-bold">Optional Details:</label>
      <textarea name="message" rows="3" class="form-control" maxlength="300"
        placeholder="Example: Saw a suspicious car circling the block repeatedly"></textarea>
      <div class="form-text">Max 300 characters. Keep it factual.</div>
    </div>
    
    <button type="submit" class="btn btn-danger w-100">
      <i class="fas fa-location-arrow"></i> Drop Pin
    </button>
    
    <a href="{% url 'crime_map' %}" class="btn btn-secondary w-100 mt-2">Cancel</a>
  </form>
</div>

<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.3/dist/leaflet.css"/>
<script src="https://unpkg.com/leaflet@1.9.3/dist/leaflet.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const map = L.map('pinMap').setView([-26.2041, 28.0473], 13);

  L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
    attribution: 'Â© OpenStreetMap contributors'
  }).addTo(map);

  let marker = null;

  if (navigator.geolocation) {
    navigator.geolocation.getCurrentPosition(pos => {
      const userLat = pos.coords.latitude;
      const userLng = pos.coords.longitude;
      map.setView([userLat, userLng], 15);
    });
  }

  map.on('click', function(e) {
    const { lat, lng } = e.latlng;
    
    if (marker) {
      map.removeLayer(marker);
    }
    
    marker = L.marker([lat, lng]).addTo(map)
      .bindPopup("Selected Location").openPopup();
    
    document.getElementById('latitude').value = lat.toFixed(6);
    document.getElementById('longitude').value = lng.toFixed(6);
  });
});
</script>
{% endblock %}
